<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Jitsi + Emotion + Notes Tracker</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js" type="module"></script>
    <style>
        video { width: 300px; border: 2px solid black; }
        #jitsi-container { height: 400px; margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #aaa; padding: 8px; }
    </style>
</head>
<body>
<h1>Live Jitsi + Emotion & Transcription Tracker</h1>
<button onclick="signIn()">Sign In with Google</button>
<div id="jitsi-container"></div>

<h2>Live Camera Feed</h2>
<video id="webcam" autoplay muted playsinline></video>
<div>
    <strong>Detected Emotion:</strong> <span id="emotion">--</span><br>
    <strong>Fatigue:</strong> <span id="fatigue">--</span>
</div>

<h2>Transcription</h2>
<div id="transcript">Waiting for input...</div>

<h2>Attendance Table</h2>
<table id="participants-table">
    <tr><th>Name</th><th>Join Time</th><th>Leave Time</th><th>Emotion</th><th>Fatigue</th></tr>
</table>

<button onclick="downloadExcel()">Download Excel</button>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, arrayUnion, connectFirestoreEmulator } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, connectAuthEmulator } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCvOzkAFJ1YxWcEEKgxosiXwHAx_tsTgVY",
      authDomain: "emotionattendanceapp.firebaseapp.com",
      projectId: "emotionattendanceapp",
      storageBucket: "emotionattendanceapp.appspot.com",
      messagingSenderId: "962091928285",
      appId: "1:962091928285:web:711ba64befa8fb7061e934",
      databaseURL: "https://emotionattendanceapp.firebaseio.com"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    if (location.hostname === "localhost") {
      connectFirestoreEmulator(db, 'localhost', 8080);
      connectAuthEmulator(auth, 'http://localhost:9099');
    }
    const provider = new GoogleAuthProvider();

    let user = null;
    let meetingId = new Date().getTime().toString();

    // Sign in
    window.signIn = function () {
      signInWithPopup(auth, provider)
        .then(res => {
          user = res.user;
          console.log("Logged in:", user.email);
        })
        .catch(error => {
          console.error("Auth error:", error.code, error.message);
        });
    };

    // Jitsi Init
    const api = new JitsiMeetExternalAPI("meet.jit.si", {
      roomName: `Room_${meetingId}`,
      width: "100%",
      height: 400,
      parentNode: document.getElementById("jitsi-container"),
      userInfo: { displayName: "Teacher" },
      configOverwrite: { disableAudioLevels: true }
    });

    api.on("participantJoined", async (event) => {
      try {
        await setDoc(doc(db, "participants", event.id), {
          name: event.displayName || `Participant_${event.id}`,
          join_time: new Date().toISOString(),
          emotions: [],
          fatigue: [],
          meetingId
        });
        console.log(`Participant ${event.id} added to Firestore`);
      } catch (error) {
        console.error("Error adding participant to Firestore:", error);
      }
    });

    api.on("participantLeft", async (event) => {
      try {
        await updateDoc(doc(db, "participants", event.id), {
          leave_time: new Date().toISOString()
        });
        console.log(`Participant ${event.id} updated in Firestore`);
      } catch (error) {
        console.error("Error updating participant in Firestore:", error);
      }
    });

    // Update Participants Table
    onAuthStateChanged(auth, user => {
      if (user) {
        console.log("User authenticated:", user.email);
        onSnapshot(collection(db, "participants"), snapshot => {
          const table = document.getElementById("participants-table");
          while (table.rows.length > 1) table.deleteRow(1);
          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            if (data.meetingId === meetingId) {
              const row = table.insertRow();
              row.insertCell().textContent = data.name;
              row.insertCell().textContent = data.join_time || "-";
              row.insertCell().textContent = data.leave_time || "-";
              row.insertCell().textContent = data.emotions.slice(-1)[0]?.emotion || "-";
              row.insertCell().textContent = data.fatigue.slice(-1)[0]?.status || "-";
            }
          });
        }, error => {
          console.error("Firestore onSnapshot error:", error.code, error.message);
        });
      } else {
        console.log("No user authenticated");
        document.getElementById("participants-table").innerHTML = "<tr><th>Name</th><th>Join Time</th><th>Leave Time</th><th>Emotion</th><th>Fatigue</th></tr><tr><td colspan='5'>Please sign in to view participants</td></tr>";
      }
    });

    // Web Speech API
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = true;
    recognition.onresult = function (event) {
      const transcript = Array.from(event.results)
        .map(result => result[0].transcript)
        .join(" ");
      document.getElementById("transcript").textContent = transcript;
    };
    recognition.onerror = function (event) {
      console.error("Speech recognition error:", event.error);
      document.getElementById("transcript").textContent = "Speech recognition failed: " + event.error;
    };
    recognition.start();

    // Webcam + Emotion Detection
    const video = document.getElementById("webcam");
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
    }).catch(error => {
      console.error("Webcam error:", error);
    });

    // Initialize face-api.js models
    async function initializeFaceAPI() {
      try {
        if (typeof faceapi !== 'undefined') {
          console.log("Loading face-api.js models...");
          await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights');
          await faceapi.nets.faceExpressionNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights');
          console.log("Face-api.js models loaded successfully");
          startEmotionDetection();
        } else {
          console.error("face-api.js not loaded");
        }
      } catch (error) {
        console.error("Error loading face-api.js models:", error);
        document.getElementById("emotion").textContent = "Model loading failed";
        document.getElementById("fatigue").textContent = "Model loading failed";
      }
    }

    function startEmotionDetection() {
      setInterval(async () => {
        try {
          const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
          if (detections?.expressions) {
            const emotion = Object.entries(detections.expressions).reduce((a, b) => a[1] > b[1] ? a : b)[0];
            const fatigue = (emotion === "neutral" || emotion === "sad") ? "Sleepy" : "Alert";
            document.getElementById("emotion").textContent = emotion;
            document.getElementById("fatigue").textContent = fatigue;
            if (user) {
              try {
                const participantRef = doc(db, "participants", user.uid);
                await updateDoc(participantRef, {
                  emotions: arrayUnion({ emotion, timestamp: new Date().toISOString() }),
                  fatigue: arrayUnion({ status: fatigue, timestamp: new Date().toISOString() })
                });
              } catch (error) {
                console.error("Error saving emotion/fatigue to Firestore:", error);
              }
            }
          }
        } catch (error) {
          console.error("Error in emotion detection:", error);
        }
      }, 3000);
    }

    // Initialize face-api.js after page loads
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initializeFaceAPI, 1000); // Give time for face-api.js to load
    });

    // Excel Download
    window.downloadExcel = function () {
      const table = document.getElementById("participants-table");
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(table);
      XLSX.utils.book_append_sheet(wb, ws, "Attendance");
      XLSX.writeFile(wb, `attendance_${meetingId}.xlsx`);
    };
</script>
</body>
</html>