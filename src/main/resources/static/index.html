<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jitsi Attendance + Emotion Tracker</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        const firebaseConfig = {
          apiKey: "AIzaSyCvOzkAFJ1YxWcEEKgxosiXwHAx_tsTgVY",
          authDomain: "emotionattendanceapp.firebaseapp.com",
          projectId: "emotionattendanceapp",
          storageBucket: "emotionattendanceapp.firebaseapp.com",
          messagingSenderId: "962091928285",
          appId: "1:962091928285:web:711ba64befa8fb7061e934"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        let sessionId = new Date().getTime().toString();
        let meetingId = new URLSearchParams(window.location.search).get('meetingId') || sessionId;

        // Authenticate teacher
        signInWithPopup(auth, provider)
          .then(result => {
            console.log("Authenticated as:", result.user.email);
          })
          .catch(error => console.error("Auth error:", error));

        // Initialize Jitsi
        const domain = 'meet.jit.si';
        const options = {
          roomName: `ClassRoomMeeting_${meetingId}`,
          width: '100%',
          height: 600,
          parentNode: document.querySelector('#jitsi-container'),
          userInfo: { displayName: 'Teacher' },
          interfaceConfigOverwrite: { TOOLBAR_BUTTONS: ['microphone', 'camera', 'desktop', 'chat', 'recording'] }
        };
        const api = new JitsiMeetExternalAPI(domain, options);

        // Participant tracking
        api.on('participantJoined', async (event) => {
          const participantId = event.id;
          const participantName = event.displayName || `Participant_${participantId}`;
          await setDoc(doc(db, "participants", participantId), {
            name: participantName,
            join_time: new Date().toISOString(),
            leave_time: null,
            emotions: [],
            fatigue: [],
            meetingId: meetingId
          });

          // Notify backend
          fetch(`/api/meetings/join/${meetingId}?userEmail=${participantName}@example.com&userName=${participantName}`, {
            method: 'POST'
          }).catch(error => console.error("Error notifying backend:", error));
        });

        api.on('participantLeft', async (event) => {
          const participantId = event.id;
          await updateDoc(doc(db, "participants", participantId), {
            leave_time: new Date().toISOString()
          });

          // Notify backend
          fetch(`/api/meetings/leave/${participantId}`, {
            method: 'POST'
          }).catch(error => console.error("Error notifying backend:", error));
        });

        // Real-time participant updates
        onSnapshot(collection(db, "participants"), snapshot => {
          const table = document.getElementById("participants-table");
          while (table.rows.length > 1) table.deleteRow(1);
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.meetingId === meetingId) {
              const row = table.insertRow();
              row.insertCell().textContent = data.name;
              row.insertCell().textContent = data.join_time || 'N/A';
              row.insertCell().textContent = data.leave_time || 'N/A';
              row.insertCell().textContent = data.emotions && data.emotions.length > 0 ? data.emotions[data.emotions.length - 1].emotion : 'N/A';
              row.insertCell().textContent = data.fatigue && data.fatigue.length > 0 ? data.fatigue[data.fatigue.length - 1].status : 'N/A';
            }
          });
        });

        // Real-time transcript and notes updates
        onSnapshot(doc(db, "sessions", sessionId), doc => {
          const data = doc.data();
          if (data) {
            document.getElementById("transcripts").textContent = data.transcription || 'No transcripts yet';
            document.getElementById("notes").textContent = data.notes || 'No notes yet';
          }
        });

        // Download Attendance Excel
        async function downloadExcel(meetingId) {
          try {
            const response = await fetch(`/api/attendance/export/${meetingId}`);
            if (!response.ok) throw new Error('Failed to download Excel');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `attendance_report_${meetingId}.xlsx`;
            link.click();
            window.URL.revokeObjectURL(url);
          } catch (error) {
            console.error("Error downloading Excel:", error);
            alert("Failed to download attendance report");
          }
        }

        // Download Notes Excel
        async function downloadNotesExcel(meetingId) {
          try {
            const response = await fetch(`/api/meetings/export/notes/${meetingId}`);
            if (!response.ok) throw new Error('Failed to download notes Excel');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `notes_${meetingId}.xlsx`;
            link.click();
            window.URL.revokeObjectURL(url);
          } catch (error) {
            console.error("Error downloading notes Excel:", error);
            alert("Failed to download notes report");
          }
        }

        // Expose functions to global scope
        window.downloadExcel = downloadExcel;
        window.downloadNotesExcel = downloadNotesExcel;
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        #jitsi-container { width: 100%; height: 600px; }
        #data-container { margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        button { padding: 10px; margin: 5px; }
    </style>
</head>
<body>
<div id="jitsi-container"></div>
<div id="data-container">
    <h2>Participants</h2>
    <table id="participants-table">
        <tr>
            <th>Name</th>
            <th>Join Time</th>
            <th>Leave Time</th>
            <th>Emotion</th>
            <th>Fatigue</th>
        </tr>
    </table>
    <h2>Transcripts</h2>
    <div id="transcripts"></div>
    <h2>Notes</h2>
    <div id="notes"></div>
    <button onclick="downloadExcel(meetingId)">Download Attendance Excel</button>
    <button onclick="downloadNotesExcel(meetingId)">Download Notes Excel</button>
</div>
</body>
</html>